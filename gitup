subadd() {
	git submodule add $1
	git submodule update --init --recursive
	SUBMODULE_ARRAY=($(git submodule status --recursive | sed -e 's/^.* \(.*\) .*/\1/'))
	for i in "${SUBMODULE_ARRAY[@]}"; do
		COMMIT=$(git -C $i rev-parse HEAD)
		BRANCH=$(git -C $i branch --no-color --no-column --format "%(refname:lstrip=2)" --contains $COMMIT | tail -n1)
		echo "checking out $BRANCH branch for $i submodule"
		git -C $i checkout $BRANCH
	done
}

subcheckout() {
	if [ "$1" = "-b" ]; then
		git checkout -b $2
		git submodule foreach --recursive git checkout -b $2
	elif [ "$1" != "" ]; then
		if git rev-parse --quiet --verify $1 > /dev/null; then
			echo "$1 branche exists on main repo"
			if git submodule foreach --recursive git rev-parse --quiet --verify $1 > /dev/null; then
				echo "$1 branche exists on all subrepos"
				git checkout $1
				git submodule foreach --recursive git checkout $1
			else
				echo "$1 branch does not exist in subrepos"
			fi
		else
			echo "$1 branch does not exist in main repo"
		fi
	else
		git checkout
		SUBMODULE_ARRAY=($(git submodule status --recursive | sed -e 's/^.* \(.*\) .*/\1/'))
		for i in "${SUBMODULE_ARRAY[@]}"; do
			COMMIT=$(git -C $i rev-parse HEAD)
			BRANCH=$(git -C $i branch --no-color --no-column --format "%(refname:lstrip=2)" --contains $COMMIT | tail -n1)
			echo "checking out $BRANCH branch for $i submodule"
			git -C $i checkout $BRANCH
		done
	fi
}

subcommit() {
	if [ "$1" = "-m" ]; then
		git commit -m "$2"
		git submodule foreach --recursive git commit -m "$2"
	else
		git commit -m "$1"
		git submodule foreach --recursive git commit -m "$1"
	fi
}

subrm() {
	TRIMMED=$(echo "$1" | sed 's:/*$::')
	rm -irf $TRIMMED
	git rm $TRIMMED
	rm -irf .git/modules/$TRIMMED
	git config --remove-section submodule.$TRIMMED
	if [ -f .gitmodules ]; then
		if ! [ -s .gitmodules ]; then
			git restore --staged .gitmodules
			rm .gitmodules
		fi
	fi
}

substatus() {
	git status
	git submodule foreach --recursive git status
}

subtag() {
	REMOTE_ARRAY=($(git remote))
	if [ "$1" = "-d" ]; then
		git tag -d $2
		git submodule foreach --recursive git tag -d $2
		for i in "${REMOTE_ARRAY[@]}"; do
			echo "removing tag $2 from remote $i in main repo"
			git push $i :refs/tags/$2
			echo "removing tag $2 from remote $i in all sub-repos"
			git submodule foreach --recursive git push $i :refs/tags/$2
		done
	elif [ "$1" = "-l" ] || [ "$1" = "" ]; then
		echo "local git tags in main repo:"
		git tag -l
		git submodule foreach --recursive git tag -l
	else
		git tag $1
		git submodule foreach --recursive git tag $1
		for i in "${REMOTE_ARRAY[@]}"; do
			git push $i $1 
			git submodule foreach --recursive git push $i $1
		done
	fi
}

help() {
	cat << EOF
usage: gitup <command>

These are the current available commands:
checkout [-b] [--recursive|--recurse-submodules] <branch>
status
EOF
}

menu() {
	if [ "$1" = "subadd" ] || [ "$1" = "subcheckout" ] || [ "$1" = "subcommit" ] || [ "$1" = "subrm" ] || [ "$1" = "substatus" ] || [ "$1" = "subtag" ]; then
		$@
	elif [ "$1" = "help" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
		help
	else
		git $@
	fi
}

menu $@
# git submodule--helper list | sed -e 's/^.* 0\t//'
